#include "bwin_utils.h"

#include <stdlib.h>
#include <ctype.h>
#include <tchar.h>

#define HANDS_ROWS (13 + 13 + 12 + 11 + 10 + 9 + 8 + 7 + 6 + 5 + 4 + 3 + 2)
#define OPPONENTS_MAX 8

enum table_type
{
	PAIRS,
	XA,
	XK,
	XQ,
	XJ,
	XT,
	X9,
	X8,
	X7,
	X6,
	X5,
	X4,
	X3,
	TABLE_TYPES_NUM
};

static unsigned char table_rows[] = { 13, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2 };
static unsigned char hand_percent[HANDS_ROWS * OPPONENTS_MAX] =
{

	85, 73, 64, 56, 49, 43, 39, 31, // AA 
	82, 69, 58, 50, 43, 38, 33, 29,
	80, 65, 54, 45, 38, 33, 28, 25,
	78, 61, 49, 40, 34, 29, 25, 22,
	75, 58, 45, 36, 30, 25, 22, 19,
	72, 54, 41, 33, 26, 22, 19, 17,
	69, 50, 38, 29, 24, 20, 18, 16,
	66, 46, 34, 26, 21, 19, 16, 15,
	63, 43, 32, 25, 20, 17, 15, 14,
	60, 40, 29, 22, 19, 16, 14, 13,
	57, 37, 25, 21, 17, 15, 14, 13,
	54, 34, 24, 19, 16, 15, 14, 13,
	50, 31, 22, 18, 16, 14, 13, 13, // 22

	67, 51, 41, 35, 31, 28, 25, 23, // AKs 
	65, 48, 39, 32, 28, 24, 22, 19, // AK
	64, 47, 37, 30, 26, 23, 20, 18,
	64, 46, 35, 29, 24, 21, 18, 16,
	63, 44, 34, 28, 23, 20, 17, 15,
	61, 42, 31, 25, 20, 17, 15, 13,
	60, 41, 30, 24, 19, 16, 14, 12,
	59, 39, 28, 22, 18, 15, 13, 11,
	58, 38, 28, 21, 17, 14, 12, 11,
	58, 38, 28, 21, 17, 14, 12, 11,
	56, 37, 27, 21, 17, 14, 12, 11,
	56, 36, 26, 20, 17, 14, 12, 10,
	55, 35, 25, 20, 16, 14, 12, 10,

	63, 47, 38, 33, 28, 25, 23, 20, // KQs
	61, 44, 35, 29, 25, 21, 19, 17, // KQ
	61, 43, 34, 28, 24, 20, 18, 16,
	60, 42, 33, 27, 22, 19, 17, 15,
	58, 40, 30, 24, 20, 17, 14, 12,
	56, 37, 27, 21, 17, 15, 13, 11,
	55, 36, 26, 21, 17, 14, 12, 10,
	54, 35, 25, 20, 16, 13, 11, 10,
	53, 34, 25, 19, 15, 13, 11, 10,
	52, 33, 23, 18, 15, 12, 11, 9,
	51, 32, 23, 18, 14, 12, 10, 9,
	50, 31, 22, 17, 14, 12, 10, 9,

	60, 44, 36, 30, 26, 23, 21, 19, // QJs
	58, 41, 33, 27, 23, 20, 17, 15, // QJ
	57, 40, 31, 26, 22, 19, 16, 14,
	56, 38, 29, 23, 19, 16, 14, 12,
	54, 35, 26, 21, 17, 14, 12, 11,
	52, 33, 24, 19, 15, 13, 11, 9,
	51, 32, 23, 18, 14, 12, 10, 9,
	50, 31, 20, 17, 14, 12, 10, 9,
	49, 30, 21, 16, 13, 11, 9, 8,
	48, 29, 21, 16, 13, 11, 9, 8,
	47, 28, 20, 15, 12, 10, 9, 8,

	58, 42, 34, 29, 25, 22, 20, 18, // JTs
	55, 39, 31, 25, 22, 19, 16, 15, // JT
	53, 37, 28, 23, 19, 16, 14, 12,
	52, 34, 26, 20, 17, 14, 12, 11,
	50, 32, 24, 18, 15, 12, 11, 9,
	48, 30, 21, 17, 13, 11, 9, 8,
	47, 29, 21, 16, 13, 11, 9, 8,
	46, 28, 20, 15, 12, 10, 9, 8,
	45, 27, 19, 15, 12, 10, 8, 7,
	44, 26, 18, 14, 11, 9, 8, 7,

	54, 39, 31, 26, 23, 20, 18, 16, // T9s
	52, 32, 28, 23, 19, 16, 14, 13, // T9
	50, 34, 25, 20, 17, 14, 13, 11,
	8, 31, 23, 18, 15, 13, 11, 10, 
	46, 29, 21, 17, 13, 11, 10, 8, 
	44, 27, 19, 15, 12, 10, 8, 7,
	43, 26, 19, 14, 12, 10, 8, 7,
	42, 26, 18, 14, 11, 9, 8, 7,
	42, 25, 17, 13, 11, 9, 8, 7,

	51, 36, 29, 24, 20, 18, 16, 15, // 98S
	48, 33, 25, 20, 17, 14, 12, 11, // 98
	47, 31, 23, 18, 16, 13, 11, 10,
	45, 29, 21, 17, 14, 11, 10, 9,
	43, 27, 19, 15, 12, 10, 9, 7,
	41, 25, 17, 13, 11, 9, 7, 6,
	40, 24, 17, 13, 10, 8, 7, 6,
	39, 23, 16, 12, 10, 8, 7, 6,

	48, 34, 27, 22, 19, 17, 15, 14, // 87s
	46, 31, 23, 19, 15, 13, 12, 10, // 87
	44, 29, 21, 17, 14, 12, 10, 9,
	42, 27, 19, 15, 12, 11, 9, 8,
	40, 24, 18, 13, 11, 9, 8, 7,
	38, 22, 16, 12, 10, 8, 7, 6,
	37, 22, 15, 11, 9, 8, 6, 6,

	46, 32, 25, 21, 18, 16, 14, 13,  // 76s
	43, 29, 22, 17, 14, 12, 11, 10,	 // 76
	41, 27, 20, 16, 13, 11, 10, 9,
	38, 25, 18, 14, 11, 10, 9, 8,
	37, 22, 16, 12, 10, 8, 7, 6,
	35, 20, 14, 11, 9, 7, 6, 5,

	43, 30, 24, 20, 17, 15, 14, 13, // 65s
	40, 27, 20, 16, 13, 12, 10, 9,  // 65
	38, 25, 18, 14, 12, 10, 9, 8,
	36, 23, 16, 13, 11, 9, 8, 7,
	34, 21, 15, 11, 9, 8, 7, 6,

	41, 29, 23, 19, 17, 15, 14, 13, // 54s
	38, 25, 19, 15, 13, 11, 10, 9,  // 54
	36, 23, 17, 14, 11, 10, 9, 8,
	34, 21, 15, 12, 10, 9, 8, 7,

	38, 26, 20, 17, 15, 13, 12, 11,  // 43s
	34, 22, 16, 13, 11, 9, 8, 8,	 // 43
	33, 21, 15, 12, 10, 8, 7, 7,

	35, 24, 18, 15, 13, 12, 11, 10, // 32s
	31, 20, 14, 11, 9, 8, 7, 6,	    // 32

};

DECLDIR unsigned char card_to_num(char c)
{
	wint_t cc;
	cc = toupper(c);

	if (cc <= _T('9') && cc >= _T('2'))
		return cc - _T('0');
	else
		switch (cc)
	{
		case _T('A'):
			return 14;
		case _T('K'):
			return 13;
		case _T('Q'):
			return 12;
		case _T('J'):
			return 11;
		case _T('T'):
			return 10;
		default:
			break;
	}

	return 0;
}

DECLDIR int card_range(char *t, int opponents, int *range)
{
	size_t len = _tcslen(t), type, table_ix = 0, i;
	char c1, c2, s;

	if (len != 2 && len != 3 || opponents < 1 || opponents > 8 || !range)
		return 1;

	c1 = t[0], c2 = t[1];

	if (!card_to_num(c1) || !card_to_num(c2))
		return 1;

	if (card_to_num(c2) > card_to_num(c1))
	{
		char tmp = c1;
		c1 = c2;
		c2 = tmp;
	}
	
	/* Table type (enum) */
	type = (c1 == c2 ? PAIRS : card_to_num(_T('A')) - card_to_num(c1) + 1);
	
	/* Add number of rows for every previous type */
	for (i = 0; i < type; i++)
		table_ix += table_rows[i] * OPPONENTS_MAX;

	if (type == PAIRS)
		table_ix += (card_to_num(_T('A')) - card_to_num(c1)) * OPPONENTS_MAX;
	else
	{
		s = (t[2] == _T('s') && ((card_to_num(c1) - card_to_num(c2)) == 1) ? 1 : 0);

		table_ix += (card_to_num(c1) - card_to_num(c2) - s) * OPPONENTS_MAX;
	}
	
	*range = hand_percent[table_ix + opponents - 1];
	return 0;
}
